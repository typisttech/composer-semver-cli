name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Git tag for the release. For example, v1.2.3'
        required: true
      run_id:
        description: 'ID of the CI workflow run that created the release assets'
        type: number
        required: true
      clobber:
        description: 'Overwrite existing assets of the same name'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ inputs.version }}
  cancel-in-progress: true

permissions: {}

jobs:
  drafter:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: release-drafter/release-drafter@v6
        with:
          version: ${{ inputs.version }}
          tag: ${{ inputs.version }}
          publish: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deb:
    needs: drafter
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: write
      actions: read
    steps:
      - uses: actions/download-artifact@v5
        with:
          name: deb
          run-id: ${{ inputs.run_id }}
          github-token: ${{ github.token }}

      - uses: actions/attest-build-provenance@v3
        with:
          subject-path: deb/*.deb

      - name: Upload debs
        run: |
          while IFS= read -u3 -r -d '' DEB; do 
            echo "::group::==> ${DEB}"
            gh release upload ${CLOBBER} --repo "${REPO}" "${TAG}" "${DEB}"
            echo "::endgroup::"
          done 3< <(find deb -type f -name '*.deb' -print0)
        env:
          CLOBBER: ${{ inputs.clobber && '--clobber' || '' }}
          REPO: ${{ github.repository }}
          TAG: ${{ inputs.version }}
          GH_TOKEN: ${{ github.token }}

  tarball:
    needs: drafter
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: write
      actions: read
    steps:
      - uses: actions/checkout@v5
        with:
          sparse-checkout: |
            README.md
            LICENSE
          sparse-checkout-cone-mode: false
          ref: ${{ inputs.version }}

      - uses: actions/download-artifact@v5
        with:
          pattern: composer-semver_*_*
          path: bin
          run-id: ${{ inputs.run_id }}
          github-token: ${{ github.token }}

      - name: Find binaries
        run: |
          declare -a DIRS
  
          while IFS= read -u3 -r -d '' FULL_BIN_PATH; do
            echo "::group::==> ${FULL_BIN_PATH}"
            full_dir=$(dirname "${FULL_BIN_PATH}")
            dir=$(basename -a "${full_dir}")
            IFS= DIRS+=($dir)
            echo "::endgroup::"
          done 3< <(find bin -maxdepth 2 -mindepth 2 -type f -name 'composer-semver' -print0)

          {
            echo 'DIRS<<EOF'
            echo "${DIRS}"
            echo EOF
          } >> "$GITHUB_ENV"

      - run: mkdir -p tarball

      - name: Create tarballs
        run: |
          for DIR in ${DIRS[@]}; do
            echo "::group::==> ${DIR}"
            cp README.md LICENSE "bin/${DIR}/"
            chmod +x "bin/${DIR}/composer-semver" && \
            tar -C "bin/${DIR}" -cvf - composer-semver README.md LICENSE | \
            gzip --best - > "tarball/${DIR}.tar.gz"
            echo "::endgroup::"
          done

      - run: echo "aaa" >> tarball/composer-semver_Linux_amd64.tar.gz
      - run: echo "aaa" >> tarball/composer-semver_Darwin_amd64.tar.gz

      - name: Validate tarballs
        run: |
          for DIR in ${DIRS[@]}; do
            echo "::group::==> ${DIR}"
            tar -ztf "tarball/${DIR}.tar.gz"
            echo "::endgroup::"
          done

      - uses: actions/attest-build-provenance@v3
        with:
          subject-path: tarball/*.tar.gz

      - name: Upload tarballs
        run: |
          for DIR in ${DIRS[@]}; do
            echo "::group::==> ${DIR}"
            gh release upload ${CLOBBER} --repo "${REPO}" "${TAG}" "tarball/${DIR}.tar.gz"
            echo "::endgroup::"
          done
        env:
          CLOBBER: ${{ inputs.clobber && '--clobber' || '' }}
          REPO: ${{ github.repository }}
          TAG: ${{ inputs.version }}
          GH_TOKEN: ${{ github.token }}
